import { useState, useEffect, useRef } from "react";
import "./ProductSharePopUp.css";
import CheckIcon from "@mui/icons-material/Check";

type Props = {
  productUrl: string;
};

export default function ProductSharePopup({ productUrl }: Props) {
  const [isOpen, setIsOpen] = useState(false);
  const [isCopied, setIsCopied] = useState(false);
  const modalRef = useRef<HTMLDivElement>(null);

  const copyLink = () => {
    navigator.clipboard.writeText(productUrl);
    setIsCopied(true);
  };

  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      if (e.key === "Escape") setIsOpen(false);
    };
    if (isOpen) {
      document.addEventListener("keydown", handleKeyDown);
    }
    return () => document.removeEventListener("keydown", handleKeyDown);
  }, [isOpen]);


  const handleOverlayClick = (e: React.MouseEvent<HTMLDivElement>) => {
    if (modalRef.current && !modalRef.current.contains(e.target as Node)) {
      setIsOpen(false);
    }
  };

  return (
    <>
      {/* دکمه SVG که باز می‌کنه */}
      <button onClick={() => setIsOpen(true)}>
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="25"
          height="24"
          viewBox="0 0 25 24"
          fill="none"
        >
          <path
            d="M21.2857 13.0703C20.9057 13.0703 20.5857 12.7803 20.5357 12.4003C20.2957 10.1403 19.0757 8.09035 17.1957 6.79035C16.8557 6.55035 16.7757 6.09035 17.0057 5.75035C17.2457 5.41035 17.7157 5.33035 18.0457 5.56035C20.2857 7.11035 21.7257 9.55035 22.0157 12.2403C22.0557 12.6503 21.7657 13.0203 21.3457 13.0703C21.3357 13.0703 21.3057 13.0703 21.2857 13.0703Z"
            fill="#2F5F8A"
          />
          <path
            d="M4.15592 13.1203C4.12592 13.1203 4.10592 13.1203 4.07592 13.1203C3.66592 13.0703 3.36592 12.7003 3.40592 12.2903C3.67592 9.60026 5.10592 7.17026 7.31592 5.60026C7.65592 5.36026 8.12592 5.44026 8.36592 5.78026C8.60592 6.12026 8.52592 6.59026 8.18592 6.83026C6.32592 8.14026 5.12592 10.1903 4.89592 12.4503C4.86592 12.8303 4.53592 13.1203 4.15592 13.1203Z"
            fill="#2F5F8A"
          />
          <path
            d="M12.724 22.61C11.244 22.61 9.83403 22.27 8.51403 21.61C8.14403 21.42 7.99403 20.97 8.18403 20.6C8.37403 20.23 8.82403 20.08 9.19403 20.27C11.354 21.36 13.954 21.38 16.134 20.33C16.504 20.15 16.954 20.31 17.134 20.68C17.314 21.05 17.154 21.5 16.784 21.68C15.504 22.3 14.144 22.61 12.724 22.61Z"
            fill="#2F5F8A"
          />
          <path
            d="M12.7253 8.43988C10.7753 8.43988 9.19531 6.85988 9.19531 4.90988C9.19531 2.95988 10.7753 1.37988 12.7253 1.37988C14.6753 1.37988 16.2553 2.95988 16.2553 4.90988C16.2553 6.85988 14.6653 8.43988 12.7253 8.43988ZM12.7253 2.88988C11.6053 2.88988 10.6953 3.79988 10.6953 4.91988C10.6953 6.03988 11.6053 6.94988 12.7253 6.94988C13.8453 6.94988 14.7553 6.03988 14.7553 4.91988C14.7553 3.79988 13.8353 2.88988 12.7253 2.88988Z"
            fill="#2F5F8A"
          />
          <path
            d="M5.49484 20.6704C3.54484 20.6704 1.96484 19.0904 1.96484 17.1404C1.96484 15.2004 3.54484 13.6104 5.49484 13.6104C7.44484 13.6104 9.02484 15.1904 9.02484 17.1404C9.02484 19.0804 7.44484 20.6704 5.49484 20.6704ZM5.49484 15.1104C4.37484 15.1104 3.46484 16.0204 3.46484 17.1404C3.46484 18.2604 4.37484 19.1704 5.49484 19.1704C6.61484 19.1704 7.52484 18.2604 7.52484 17.1404C7.52484 16.0204 6.61484 15.1104 5.49484 15.1104Z"
            fill="#2F5F8A"
          />
          <path
            d="M19.8347 20.6704C17.8847 20.6704 16.3047 19.0904 16.3047 17.1404C16.3047 15.2004 17.8847 13.6104 19.8347 13.6104C21.7847 13.6104 23.3647 15.1904 23.3647 17.1404C23.3547 19.0804 21.7747 20.6704 19.8347 20.6704ZM19.8347 15.1104C18.7147 15.1104 17.8047 16.0204 17.8047 17.1404C17.8047 18.2604 18.7147 19.1704 19.8347 19.1704C20.9547 19.1704 21.8647 18.2604 21.8647 17.1404C21.8547 16.0204 20.9547 15.1104 19.8347 15.1104Z"
            fill="#2F5F8A"
          />
        </svg>
      </button>

      {/* پاپ آپ */}
      {isOpen && (
        <div className="popup-overlay" onClick={handleOverlayClick}>
          <div className="popup-content" ref={modalRef}>
            <div className="popup-top">
              <p className="pop-up__share-title">اشتراک ‌گذاری</p>
              <button className="close-btn" onClick={() => setIsOpen(false)}>
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="20"
                  height="20"
                  viewBox="0 0 20 20"
                  fill="none"
                >
                  <path
                    d="M7.64245 12.9841C7.48411 12.9841 7.32578 12.9258 7.20078 12.8008C6.95911 12.5591 6.95911 12.1591 7.20078 11.9174L11.9174 7.20078C12.1591 6.95911 12.5591 6.95911 12.8008 7.20078C13.0424 7.44245 13.0424 7.84245 12.8008 8.08411L8.08411 12.8008C7.96745 12.9258 7.80078 12.9841 7.64245 12.9841Z"
                    fill="#032340"
                  />
                  <path
                    d="M12.3591 12.9841C12.2008 12.9841 12.0424 12.9258 11.9174 12.8008L7.20078 8.08411C6.95911 7.84245 6.95911 7.44245 7.20078 7.20078C7.44245 6.95911 7.84245 6.95911 8.08411 7.20078L12.8008 11.9174C13.0424 12.1591 13.0424 12.5591 12.8008 12.8008C12.6758 12.9258 12.5174 12.9841 12.3591 12.9841Z"
                    fill="#032340"
                  />
                  <path
                    d="M12.5013 18.9587H7.5013C2.9763 18.9587 1.04297 17.0253 1.04297 12.5003V7.50033C1.04297 2.97533 2.9763 1.04199 7.5013 1.04199H12.5013C17.0263 1.04199 18.9596 2.97533 18.9596 7.50033V12.5003C18.9596 17.0253 17.0263 18.9587 12.5013 18.9587ZM7.5013 2.29199C3.65964 2.29199 2.29297 3.65866 2.29297 7.50033V12.5003C2.29297 16.342 3.65964 17.7087 7.5013 17.7087H12.5013C16.343 17.7087 17.7096 16.342 17.7096 12.5003V7.50033C17.7096 3.65866 16.343 2.29199 12.5013 2.29199H7.5013Z"
                    fill="#032340"
                  />
                </svg>
              </button>
            </div>
            <div className="popup-buttom">
              <p className="popup-bottom__description">
                از طریق لینک زیر میتوانید آن را به اشتراک بگذارید
              </p>

              <button
                onClick={copyLink}
                disabled={isCopied}
                className={`copy-btn ${isCopied ? "copied" : ""}`}
              >
                {isCopied ? (
                  <>
                    <CheckIcon />
                    کپی شد
                  </>
                ) : (
                  <>
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="25"
                      height="24"
                      viewBox="0 0 25 24"
                      fill="none"
                    >
                      <path
                        d="M11.6 22.75H7.4C3.49 22.75 1.75 21.01 1.75 17.1V12.9C1.75 8.99 3.49 7.25 7.4 7.25H11.6C15.51 7.25 17.25 8.99 17.25 12.9V17.1C17.25 21.01 15.51 22.75 11.6 22.75ZM7.4 8.75C4.3 8.75 3.25 9.8 3.25 12.9V17.1C3.25 20.2 4.3 21.25 7.4 21.25H11.6C14.7 21.25 15.75 20.2 15.75 17.1V12.9C15.75 9.8 14.7 8.75 11.6 8.75H7.4Z"
                        fill="#032340"
                      />
                      <path
                        d="M17.6 16.75H16.5C16.09 16.75 15.75 16.41 15.75 16V12.9C15.75 9.8 14.7 8.75 11.6 8.75H8.5C8.09 8.75 7.75 8.41 7.75 8V6.9C7.75 2.99 9.49 1.25 13.4 1.25H17.6C21.51 1.25 23.25 2.99 23.25 6.9V11.1C23.25 15.01 21.51 16.75 17.6 16.75ZM17.25 15.25H17.6C20.7 15.25 21.75 14.2 21.75 11.1V6.9C21.75 3.8 20.7 2.75 17.6 2.75H13.4C10.3 2.75 9.25 3.8 9.25 6.9V7.25H11.6C15.51 7.25 17.25 8.99 17.25 12.9V15.25Z"
                        fill="#292D32"
                      />
                    </svg>
                    کپی کردن لینک
                  </>
                )}
              </button>
            </div>
          </div>
        </div>
      )}
    </>
  );
}
